<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Security-Policy"
content="
  default-src 'self';
  script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com;
  connect-src 'self' https://www.google-analytics.com;
  frame-src 'self';
  img-src 'self' data:;
  style-src 'self' 'unsafe-inline';
  worker-src 'self' blob:;
">
  
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-YXC3GLYKFL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-YXC3GLYKFL');
</script>

<link rel="stylesheet" href="code-styles.css">

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Complete PKI & HTTPS Setup Guide - RGBPK</title>

<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 40px auto;
    max-width: 1000px;
    background-color: #f7f9fc;
    color: #000000;
    line-height: 1.6;
    padding: 0 20px;
    min-height: 100vh;
  }

  h1, h2, h3, h4 {
    color: #2c3e50;
    margin-top: 1.5em;
    margin-bottom: 0.5em;
  }

  h1 {
    text-align: center;
    padding-top: 10px;
    border-bottom: 3px solid #2980b9;
    padding-bottom: 10px;
  }

  h2 {
    border-bottom: 2px solid #3498db;
    padding-bottom: 8px;
  }

  h3 {
    color: #34495e;
  }

  /* Version badge styling */
  .version-info {
    text-align: center;
    margin: 10px 0 10px 0;
    font-size: 0.9em;
    color: #7f8c8d;
  }

  .version-badge {
    display: inline-block;
    background-color: #3498db;
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    margin: 0 5px;
    font-weight: 600;
  }

  pre {
    background-color: #2d2d2d;
    color: #f8f8f2;
    padding: 15px;
    border-radius: 6px;
    overflow-x: auto;
    border-left: 4px solid #2980b9;
    margin: 1em 0;
  }

  code {
    font-family: 'Courier New', Courier, monospace;
    font-size: 0.9em;
  }

  pre code {
    display: block;
    line-height: 1.5;
  }

  :not(pre) > code {
    background-color: #ecf0f1;
    color: #e74c3c;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.9em;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5em 0;
    background-color: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  th, td {
    padding: 12px;
    text-align: left;
    border: 1px solid #ddd;
  }

  th {
    background-color: #2980b9;
    color: white;
    font-weight: 600;
  }

  tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  ul, ol {
    margin: 1em 0;
    padding-left: 30px;
  }

  li {
    margin: 0.5em 0;
  }

  blockquote {
    border-left: 4px solid #2980b9;
    margin: 1.5em 0;
    padding: 10px 20px;
    background-color: #ecf0f1;
    font-style: italic;
  }

  hr {
    border: none;
    border-top: 2px solid #bdc3c7;
    margin: 2em 0;
  }

  a {
    color: #2980b9;
    text-decoration: none;
  }

  a:hover {
    text-decoration: underline;
  }

  /* Sticky Back Button top left */
  .back-to-portfolio {
    position: fixed;
    top: 10px;
    left: 20px;
    background-color: #2980b9;
    color: white;
    padding: 8px 14px;
    border-radius: 6px;
    font-weight: 600;
    text-decoration: none;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    gap: 8px;
    z-index: 10000;
    transition: background-color 0.3s ease;
    font-size: 1em;
    user-select: none;
  }

  .back-to-portfolio:hover {
    background-color: #1c5980;
  }

  .back-to-portfolio svg {
    width: 18px;
    height: 18px;
    fill: white;
    flex-shrink: 0;
  }

  /* Floating circular back button */
  .back-button {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #2980b9;
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    transition: background-color 0.3s ease;
    z-index: 1000;
    cursor: pointer;
  }

  .back-button:hover {
    background-color: #555;
  }

  .back-button svg {
    width: 24px;
    height: 24px;
    fill: white;
  }

  .description {
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 2em;
  }

  /* Note boxes */
  .note-box {
    background-color: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 15px;
    margin: 1.5em 0;
    border-radius: 4px;
  }

  .note-box strong {
    color: #856404;
  }

  /* Important/Critical boxes */
  .critical-box {
    background-color: #f8d7da;
    border-left: 4px solid #dc3545;
    padding: 15px;
    margin: 1.5em 0;
    border-radius: 4px;
  }

  .critical-box strong {
    color: #721c24;
  }

  /* Success/tip boxes */
  .success-box {
    background-color: #d4edda;
    border-left: 4px solid #28a745;
    padding: 15px;
    margin: 1.5em 0;
    border-radius: 4px;
  }

  .success-box strong {
    color: #155724;
  }

  footer {
    margin-top: 60px;
    padding: 20px 0;
    border-top: 2px solid #bdc3c7;
    text-align: center;
    font-size: 0.9em;
    color: #7f8c8d;
  }

  footer a {
    color: #2980b9;
  }

  @media (max-width: 768px) {
    body {
      margin: 20px auto;
      padding: 0 15px;
    }

    h1 {
      font-size: 1.8em;
    }

    pre {
      font-size: 0.85em;
    }

    table {
      font-size: 0.9em;
    }
  }
</style>
</head>

<body>
<a href="index.html" class="back-to-portfolio" aria-label="Back to Portfolio">
  <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
  </svg>
  Back to Portfolio
</a>

<!-- Floating Back Button -->
<a href="#" onclick="goBackOrDefault(event)" class="back-button" aria-label="Go Back">
  <svg viewBox="0 0 24 24">
    <path d="M15 18l-6-6 6-6" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</a>

<script>
  function goBackOrDefault(event, defaultUrl = '/CYSEC/') {
    event.preventDefault();
    if (document.referrer && document.referrer !== window.location.href) {
      window.history.back();
    } else {
      window.location.href = defaultUrl;
    }
  }
</script>

<!-- Main Content -->
<h1>Complete Guide: 
  Setting Up CA and HTTPS for Your Network Devices</h1>

<div class="version-info">
  <span class="version-badge">Version 1.2</span>
  <span class="version-badge">February 2026</span>
  <br>
  <em>Created by RGBPK for educational and informative purposes.</em>
</div>

<div class="description">
  <h2>Overview</h2>
  <p>
    This guide walks you through creating a Certificate Authority (CA) on your Mac/Linux workstation, generating certificates for two network devices, and configuring HTTPS with trusted certificates.
  </p>
  
  <h3>What you'll set up:</h3>
  <ul>
    <li>Certificate Authority on your workstation</li>
    <li>HTTPS for Device1 (${DEVICE1_IP}) - ${DEVICE1_HOSTNAME}.lan</li>
    <li>HTTPS for Device2 (${DEVICE2_IP}) - ${DEVICE2_HOSTNAME}.lan</li>
    <li>Trusted certificates in browsers and on the devices themselves</li>
  </ul>
  
  <p><strong>Important:</strong> We use .lan domain extension instead of .local to avoid mDNS conflicts on iOS/macOS devices.</p>
</div>

<hr>

<h2>Quick Reference: Your Values</h2>
<p>Fill this out before starting:</p>

<table>
  <thead>
    <tr>
      <th>Variable</th>
      <th>Your Value</th>
      <th>Example</th>
    </tr>
  </thead>
  <tbody>
    <tr><td>${DEVICE1_HOSTNAME}</td><td>_________</td><td>pihole</td></tr>
    <tr><td>${DEVICE1_IP}</td><td>_________</td><td>192.168.1.100</td></tr>
    <tr><td>${DEVICE2_HOSTNAME}</td><td>_________</td><td>suricata</td></tr>
    <tr><td>${DEVICE2_IP}</td><td>_________</td><td>192.168.1.101</td></tr>
    <tr><td>${COUNTRY}</td><td>_________</td><td>US</td></tr>
    <tr><td>${STATE}</td><td>_________</td><td>TX</td></tr>
    <tr><td>${CITY}</td><td>_________</td><td>Houston</td></tr>
    <tr><td>${ORG_NAME}</td><td>_________</td><td>HomeLab</td></tr>
    <tr><td>${ORG_UNIT}</td><td>_________</td><td>IT</td></tr>
    <tr><td>${EMAIL}</td><td>_________</td><td>admin@example.com</td></tr>
    <tr><td>CA Passphrase</td><td>_________</td><td>(SAVE SECURELY!)</td></tr>
  </tbody>
</table>

<p>Keep this reference handy while following the guide.</p>

<hr>

<h2>Part 1: Create Certificate Authority on Mac/Linux</h2>

<h3>Step 1: Install OpenSSL (if needed)</h3>

<p><strong>macOS:</strong></p>
<pre><code class="language-bash"># Check if OpenSSL is installed
openssl version

# If not installed, install via Homebrew
brew install openssl</code></pre>

<p><strong>Linux:</strong></p>
<pre><code class="language-bash"># Check if OpenSSL is installed
openssl version

# If not installed
sudo apt install openssl  # Debian/Ubuntu
sudo yum install openssl  # RHEL/CentOS</code></pre>

<h3>Step 2: Create CA Directory Structure</h3>

<pre><code class="language-bash"># Create directory for CA files
mkdir -p ~/CA/{certs,crl,newcerts,private,requests}
cd ~/CA

# Create index and serial files
touch index.txt
echo 1000 &gt; serial
echo 1000 &gt; crlnumber</code></pre>

<h3>Step 3: Create CA Configuration File</h3>

<pre><code class="language-bash">cat &gt; ~/CA/openssl.cnf &lt;&lt; 'EOF'
[ ca ]
default_ca = CA_default

[ CA_default ]
dir               = REPLACE_WITH_HOME/CA
certs             = $dir/certs
crl_dir           = $dir/crl
new_certs_dir     = $dir/newcerts
database          = $dir/index.txt
serial            = $dir/serial
RANDFILE          = $dir/private/.rand
private_key       = $dir/private/ca.key
certificate       = $dir/certs/ca.crt
crlnumber         = $dir/crlnumber
crl               = $dir/crl/ca.crl
crl_extensions    = crl_ext
default_crl_days  = 30
default_md        = sha256
name_opt          = ca_default
cert_opt          = ca_default
default_days      = 375
preserve          = no
policy            = policy_loose

[ policy_loose ]
countryName             = optional
stateOrProvinceName     = optional
localityName            = optional
organizationName        = optional
organizationalUnitName  = optional
commonName              = supplied
emailAddress            = optional

[ req ]
default_bits        = 4096
distinguished_name  = req_distinguished_name
string_mask         = utf8only
default_md          = sha256
x509_extensions     = v3_ca

[ req_distinguished_name ]
countryName                     = Country Name (2 letter code)
stateOrProvinceName             = State or Province Name
localityName                    = Locality Name
0.organizationName              = Organization Name
organizationalUnitName          = Organizational Unit Name
commonName                      = Common Name
emailAddress                    = Email Address

[ v3_ca ]
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer
basicConstraints = critical, CA:true
keyUsage = critical, digitalSignature, cRLSign, keyCertSign

[ v3_intermediate_ca ]
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer
basicConstraints = critical, CA:true, pathlen:0
keyUsage = critical, digitalSignature, cRLSign, keyCertSign

[ usr_cert ]
basicConstraints = CA:FALSE
nsCertType = client, email
nsComment = "OpenSSL Generated Client Certificate"
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer
keyUsage = critical, nonRepudiation, digitalSignature, keyEncipherment
extendedKeyUsage = clientAuth, emailProtection

[ server_cert ]
basicConstraints = CA:FALSE
nsCertType = server
nsComment = "OpenSSL Generated Server Certificate"
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer:always
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[ crl_ext ]
authorityKeyIdentifier=keyid:always

[ ocsp ]
basicConstraints = CA:FALSE
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer
keyUsage = critical, digitalSignature
extendedKeyUsage = critical, OCSPSigning

[ alt_names ]
DNS.1 = ${DEVICE1_HOSTNAME}.lan
DNS.2 = ${DEVICE1_HOSTNAME}
IP.1  = ${DEVICE1_IP}
EOF</code></pre>

<p><strong>Replace REPLACE_WITH_HOME with your actual home directory:</strong></p>

<pre><code class="language-bash"># On macOS, run:
sed -i '' "s|REPLACE_WITH_HOME|$HOME|g" ~/CA/openssl.cnf

# On Linux, run:
sed -i "s|REPLACE_WITH_HOME|$HOME|g" ~/CA/openssl.cnf</code></pre>

<div class="note-box">
  <strong>Important Note:</strong> The [ alt_names ] section will be updated before signing each certificate. This is a placeholder for Device1 initially.
</div>

<h3>Step 4: Generate CA Private Key</h3>

<pre><code class="language-bash">cd ~/CA

# Generate 4096-bit RSA key (you'll be prompted for a passphrase)
openssl genrsa -aes256 -out private/ca.key 4096

# Set strict permissions
chmod 400 private/ca.key</code></pre>

<div class="critical-box">
  <strong>CRITICAL:</strong> Save this passphrase securely in a password manager immediately. You'll need it to sign certificates and cannot recover it if lost.
</div>

<h3>Step 5: Create CA Certificate</h3>

<pre><code class="language-bash"># Create self-signed root certificate (valid for 10 years)
openssl req -config openssl.cnf \
    -key private/ca.key \
    -new -x509 -days 3650 -sha256 -extensions v3_ca \
    -out certs/ca.crt

# When prompted, enter your information:
# Country Name: ${COUNTRY}
# State: ${STATE}
# Locality: ${CITY}
# Organization Name: ${ORG_NAME}
# Organizational Unit: ${ORG_UNIT}
# Common Name: Root CA
# Email: ${EMAIL}</code></pre>

<h3>Step 6: Verify CA Certificate</h3>

<pre><code class="language-bash"># Verify the certificate
openssl x509 -noout -text -in certs/ca.crt

# Should show:
# - Issuer and Subject are the same (self-signed)
# - CA:TRUE
# - Valid for 10 years</code></pre>

<hr>

<h2>Part 2: Trust the CA on Your Workstation</h2>

<h3>Step 7: Add CA to System Trust Store</h3>

<p><strong>macOS:</strong></p>
<pre><code class="language-bash"># Open the CA certificate
open ~/CA/certs/ca.crt</code></pre>

<p>In Keychain Access:</p>
<ol>
  <li>The certificate will be added to "login" keychain</li>
  <li>Double-click the certificate named "Root CA"</li>
  <li>Expand the "Trust" section</li>
  <li>Set "When using this certificate" to "Always Trust"</li>
  <li>Close the window - you'll be prompted for your password</li>
  <li>Enter your password to confirm</li>
</ol>

<p><strong>Linux:</strong></p>
<pre><code class="language-bash"># Copy CA to system trust store
sudo cp ~/CA/certs/ca.crt /usr/local/share/ca-certificates/home-ca.crt
sudo update-ca-certificates

# Should show: 1 added</code></pre>

<h3>Step 8: Verify Trust</h3>

<p><strong>macOS:</strong></p>
<pre><code class="language-bash">security verify-cert -c ~/CA/certs/ca.crt
# Should return: ...certificate verification successful.</code></pre>

<p><strong>Linux:</strong></p>
<pre><code class="language-bash">openssl verify -CAfile ~/CA/certs/ca.crt ~/CA/certs/ca.crt
# Should return: ...OK</code></pre>

<hr>

<h2>Part 3: Generate Certificate for Device1</h2>

<h3>Step 9: Create Certificate Signing Request (CSR) Configuration</h3>

<pre><code class="language-bash"># Note: You'll need to edit this file after creation to replace ${VARIABLE} placeholders
cat &gt; ~/CA/requests/${DEVICE1_HOSTNAME}.cnf &lt;&lt; 'EOF'
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
req_extensions     = req_ext
prompt             = no

[ req_distinguished_name ]
countryName                = ${COUNTRY}
stateOrProvinceName        = ${STATE}
localityName              = ${CITY}
organizationName          = ${ORG_NAME}
organizationalUnitName    = ${ORG_UNIT}
commonName                = ${DEVICE1_HOSTNAME}.lan
emailAddress              = ${EMAIL}

[ req_ext ]
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = ${DEVICE1_HOSTNAME}.lan
DNS.2 = ${DEVICE1_HOSTNAME}
IP.1  = ${DEVICE1_IP}
EOF

# Now edit the file to replace variables with your actual values
nano ~/CA/requests/${DEVICE1_HOSTNAME}.cnf
# Replace all ${COUNTRY}, ${STATE}, ${CITY}, ${ORG_NAME}, ${ORG_UNIT}, 
# ${DEVICE1_HOSTNAME}, ${DEVICE1_IP}, and ${EMAIL} with your actual values
# Save and exit (Ctrl+O, Enter, Ctrl+X)</code></pre>

<h3>Step 10: Generate Private Key for Device1</h3>

<pre><code class="language-bash">cd ~/CA

# Generate 2048-bit key (no passphrase for server use)
openssl genrsa -out requests/${DEVICE1_HOSTNAME}.key 2048

# Set permissions
chmod 400 requests/${DEVICE1_HOSTNAME}.key</code></pre>

<h3>Step 11: Create CSR for Device1</h3>

<pre><code class="language-bash"># Generate CSR with extensions
openssl req -new -key requests/${DEVICE1_HOSTNAME}.key \
    -out requests/${DEVICE1_HOSTNAME}.csr \
    -config requests/${DEVICE1_HOSTNAME}.cnf \
    -reqexts req_ext

# Verify CSR includes SANs
openssl req -text -noout -in requests/${DEVICE1_HOSTNAME}.csr | grep -A5 "Subject Alternative Name"

# Should show: DNS:${DEVICE1_HOSTNAME}.lan, DNS:${DEVICE1_HOSTNAME}, IP Address:${DEVICE1_IP}</code></pre>

<h3>Step 12: Update openssl.cnf for Device1 and Sign Certificate</h3>

<pre><code class="language-bash">cd ~/CA

# CRITICAL: Update the [ alt_names ] section in openssl.cnf
nano openssl.cnf</code></pre>

<p>Find the [ alt_names ] section at the bottom and update it:</p>
<pre><code>[ alt_names ]
DNS.1 = ${DEVICE1_HOSTNAME}.lan
DNS.2 = ${DEVICE1_HOSTNAME}
IP.1  = ${DEVICE1_IP}</code></pre>

<p>Save and exit, then sign:</p>

<pre><code class="language-bash"># Sign the certificate with your CA (valid for 1 year)
openssl ca -config openssl.cnf \
    -extensions server_cert -days 375 -notext -md sha256 \
    -in requests/${DEVICE1_HOSTNAME}.csr \
    -out certs/${DEVICE1_HOSTNAME}.crt

# Type 'y' to confirm (twice)
# Enter CA passphrase when prompted

# Verify the signed certificate has SANs
openssl x509 -in certs/${DEVICE1_HOSTNAME}.crt -text -noout | grep -A5 "Subject Alternative Name"

# Should show: DNS:${DEVICE1_HOSTNAME}.lan, DNS:${DEVICE1_HOSTNAME}, IP Address:${DEVICE1_IP}</code></pre>

<hr>

<h2>Part 4: Generate Certificate for Device2</h2>

<p><em>(Follow the same process as Part 3, but replace all instances of DEVICE1 with DEVICE2)</em></p>

<h3>Step 13: Create CSR Configuration for Device2</h3>
<h3>Step 14: Generate Private Key for Device2</h3>
<h3>Step 15: Create CSR for Device2</h3>
<h3>Step 16: Update openssl.cnf for Device2 and Sign Certificate</h3>

<p><em>Detailed steps omitted for brevity - follow Part 3 steps but use Device2 values.</em></p>

<hr>

<h2>Part 5: Install Certificates on Your Devices</h2>

<p>The installation steps depend on what web server your device uses. Common scenarios:</p>

<hr>

<h3>Scenario A: Pi-hole (using Pi-hole FTL v6+)</h3>

<div class="critical-box">
  <h4>Important: Pi-hole FTL Certificate Requirements</h4>
  <p><strong>Pi-hole FTL has specific certificate chain requirements that differ from traditional web servers like Nginx or Apache.</strong></p>
  
  <p>Unlike Nginx (which uses separate <code>ssl_certificate</code> and <code>ssl_certificate_key</code> directives), Pi-hole's FTL web server requires all certificate components in a <strong>single PEM file</strong> in this exact order:</p>
  
  <ol>
    <li>Server certificate (pihole.crt)</li>
    <li>CA certificate (ca.crt)</li>
    <li>Private key (pihole.key)</li>
  </ol>
  
  <p><strong>Why this matters:</strong></p>
  <ul>
    <li>If the CA certificate is missing from the chain, browsers will show "Unable to verify the first certificate"</li>
    <li>If the order is incorrect, FTL won't serve HTTPS properly</li>
    <li>Other web servers handle chain assembly automatically; FTL requires manual bundling</li>
  </ul>
  
  <p><strong>Common mistake:</strong> Many guides only include the server certificate and key in <code>tls.pem</code>, omitting the CA certificate. This causes certificate validation errors even though the certificates are technically valid.</p>
  
  <p>This guide includes the CA certificate in the PEM bundle to ensure the full certificate chain is presented to clients, eliminating trust errors.</p>
</div>

<h4>Step 17a: Copy Certificates to Pi-hole</h4>

<p>From your workstation, copy the certificates AND the CA certificate:</p>

<pre><code class="language-bash"># Copy server certificate and key (replace ${USER} and ${DEVICE1_IP})
scp ~/CA/certs/${DEVICE1_HOSTNAME}.crt ${USER}@${DEVICE1_IP}:/tmp/
scp ~/CA/requests/${DEVICE1_HOSTNAME}.key ${USER}@${DEVICE1_IP}:/tmp/

# Copy CA certificate (CRITICAL - needed for certificate chain)
scp ~/CA/certs/ca.crt ${USER}@${DEVICE1_IP}:/tmp/</code></pre>

<h4>Step 18a: SSH into Pi-hole and Install Certificates</h4>

<pre><code class="language-bash"># SSH into Pi-hole
ssh ${USER}@${DEVICE1_IP}

# Move certificates to proper location
sudo cp /tmp/${DEVICE1_HOSTNAME}.crt /etc/pihole/
sudo cp /tmp/${DEVICE1_HOSTNAME}.key /etc/pihole/
sudo cp /tmp/ca.crt /etc/pihole/tls_ca.crt

# Create combined PEM file with FULL CHAIN (Pi-hole FTL requires this format)
# Order matters: certificate, CA cert, then private key
sudo bash -c "cat /etc/pihole/${DEVICE1_HOSTNAME}.crt /etc/pihole/tls_ca.crt /etc/pihole/${DEVICE1_HOSTNAME}.key &gt; /etc/pihole/tls.pem"

# Set ownership and permissions
sudo chown pihole:pihole /etc/pihole/tls.pem
sudo chmod 600 /etc/pihole/tls.pem

# Verify the PEM has correct SANs
sudo openssl x509 -in /etc/pihole/tls.pem -text -noout | grep -A3 "Subject Alternative Name"
# Should show: DNS:${DEVICE1_HOSTNAME}.lan, DNS:${DEVICE1_HOSTNAME}, IP Address:${DEVICE1_IP}

# Verify the PEM contains full chain (should show 2 certificates + 1 key)
sudo grep -c "BEGIN CERTIFICATE" /etc/pihole/tls.pem
# Should return: 2

sudo grep -c "BEGIN.*PRIVATE KEY" /etc/pihole/tls.pem
# Should return: 1</code></pre>

<p><em>Continue with remaining Pi-hole configuration steps...</em></p>

<hr>

<h3>Scenario B: Nginx Web Server</h3>

<div class="note-box">
  <p><strong>Note for Nginx:</strong> Unlike Pi-hole FTL, Nginx uses separate certificate files and automatically handles the certificate chain. You only need to provide the server certificate and key - the CA certificate is optional (can be provided via <code>ssl_trusted_certificate</code> for OCSP stapling, but not required for basic HTTPS).</p>
</div>

<p><em>Nginx installation steps follow...</em></p>

<hr>

<h2>Common Mistakes to Avoid</h2>

<ol>
  <li><strong>Forgetting CA passphrase:</strong> Write it down during Step 4 - you can't recover it</li>
  <li><strong>Wrong certificate order in tls.pem:</strong> For Pi-hole, must be: cert, CA, key (not key, cert, CA)</li>
  <li><strong>Not updating [ alt_names ] before signing:</strong> Each device needs its own SANs</li>
  <li><strong>Using .local instead of .lan:</strong> Will break on iOS/macOS devices</li>
  <li><strong>Forgetting to copy ca.crt to Pi-hole:</strong> Most common cause of "Unable to verify" errors</li>
  <li><strong>Not installing CA on client devices:</strong> Certificates won't be trusted until CA is installed</li>
</ol>

<hr>

<h2>Troubleshooting</h2>

<h3>Certificate Not Trusted</h3>
<ul>
  <li>Verify CA is installed in system trust store</li>
  <li>Check trust settings (macOS: "Always Trust")</li>
  <li>Clear browser cache</li>
  <li>Restart browser completely</li>
</ul>

<h3>Certificate Expired</h3>
<p>Certificates are valid for 375 days. If expired:</p>
<ol>
  <li>Check expiration date:
    <pre><code class="language-bash">openssl x509 -in ~/CA/certs/${DEVICE_HOSTNAME}.crt -noout -dates</code></pre>
  </li>
  <li>Generate and deploy new certificate (see "Renewal" section)</li>
  <li>Set calendar reminder: 1 year from today to renew all certificates</li>
</ol>

<hr>

<h2>Security Best Practices</h2>

<h3>Backup Strategy</h3>

<p><strong>Full backup:</strong></p>
<pre><code class="language-bash">tar -czf CA-backup-$(date +%Y%m%d).tar.gz ~/CA/</code></pre>

<p><strong>Storage:</strong></p>
<ul>
  <li>Store encrypted offsite (encrypted USB drive, encrypted cloud storage)</li>
  <li><strong>CRITICAL:</strong> Backup includes the CA private key passphrase (store separately in password manager)</li>
  <li>Test restore procedure annually</li>
  <li>If CA is compromised, ALL certificates must be regenerated</li>
</ul>

<h3>Other Best Practices</h3>
<ul>
  <li><strong>Protect CA private key passphrase</strong> - use password manager</li>
  <li><strong>Set certificate renewal reminders</strong> - before 375-day expiration</li>
  <li><strong>Never share CA private key</strong></li>
  <li><strong>Use strong passphrases</strong> (minimum 20 characters)</li>
  <li><strong>Limit CA access</strong> - only use for signing, keep offline when possible</li>
  <li><strong>Monitor certificate expiration</strong> - automate checks if possible</li>
</ul>

<hr>

<h2>Important Notes</h2>

<h3>Why .lan?</h3>
<p>The <code>.local</code> domain is reserved for mDNS. iOS/macOS prioritize mDNS for <code>.local</code>, causing DNS resolution failures. Use <code>.lan</code> to avoid conflicts.</p>

<h3>File Locations</h3>
<ul>
  <li><strong>CA certificate:</strong> <code>~/CA/certs/ca.crt</code></li>
  <li><strong>CA private key:</strong> <code>~/CA/private/ca.key</code></li>
  <li><strong>Device certificates:</strong> <code>~/CA/certs/${DEVICE_HOSTNAME}.crt</code></li>
  <li><strong>Device keys:</strong> <code>~/CA/requests/${DEVICE_HOSTNAME}.key</code></li>
</ul>

<hr>

<div class="success-box">
  <h3>Your network now has proper HTTPS with trusted certificates! ðŸ”’</h3>
</div>

<hr>

<p style="text-align: center; margin-top: 40px;">
  <strong>Version History:</strong><br>
  v1.2 (February 2026): Added certificate chain clarifications, improved troubleshooting, enhanced security notes<br>
  v1.1: Initial public release
</p>

<footer>
  <div>
    <p>&copy; 2026 Perry Kingston | Cybersecurity Professional</p>
    <p>
      <strong>Site Security:</strong> This portfolio implements 
      <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP" target="_blank" rel="noopener noreferrer">Content Security Policy (CSP)</a> headers, 
      HTTPS-only connections, and follows 
      <a href="https://owasp.org/www-project-top-ten/" target="_blank" rel="noopener noreferrer">OWASP</a> security best practices.
    </p>
    <p>
      This site uses Google Analytics for traffic analysis. No personal information is collected or stored.<br>
      By using this site, you acknowledge standard web analytics practices.
      For more information, see <a href="privacy.html" target="_blank" rel="noopener noreferrer" class="privacy-link">Privacy Policy</a>
    </p>
  </div>
</footer>

</body>
</html>
